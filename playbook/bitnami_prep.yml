---
- hosts: all
  become: yes

  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Create odoo_backup directory
      file:
        path: /home/bitnami/odoo_backup
        state: directory
        owner: bitnami
        group: odoo
        mode: 0775

    - name: Create .aws directory
      file:
        path: /home/bitnami/.aws
        state: directory
        owner: bitnami
        group: bitnami


    - name: Copy AWS credential file to odoo server
      copy:
        src: ~/.aws/credentials
        dest: /home/bitnami/.aws/credentials

    - name: Add custom_addons as addons_path to odoo.conf
      lineinfile:
        path: /opt/bitnami/odoo/conf/odoo.conf
        regexp: '^addons_path'
        line: 'addons_path = /opt/bitnami/odoo/addons,/home/bitnami/custom_addons'
        backup: yes

    - name: Install necessary python libraries
      shell: "pip3 install --upgrade pip; pip3 install paramiko dropbox"

    - name: Restart all odoo related services
      shell: "/opt/bitnami/ctlscript.sh restart"

    - name: Stop and disable timesyncd
      shell: "systemctl stop systemd-timesyncd; systemctl disable systemd-timesyncd"

    - name: Ensure chrony is present
      apt:  name=chrony state=present
